<!DOCTYPE html>
<html>

<head>
    	<title>EasyNVR</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" href="./adminlte-2.3.6/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/font-awesome-4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/ionicons-2.0.1/css/ionicons.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/AdminLTE.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/skins/skin-green.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

	<script src="./adminlte-2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
	<script src="./adminlte-2.3.6/bootstrap/js/bootstrap.min.js"></script>
	<script src="./adminlte-2.3.6/dist/js/app.js"></script>
	<script src="./adminlte-2.3.6/plugins/slimScroll/jquery.slimscroll.min.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/iCheck/all.css">
	<script src="./adminlte-2.3.6/plugins/iCheck/icheck.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/md5/jquery.md5.js"></script>
	<script src="./adminlte-2.3.6/plugins/input-number/jquery.inputnumber.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/gritter/jquery.gritter.css">
	<script src="./adminlte-2.3.6/plugins/gritter/jquery.gritter.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.css">
	<script src="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/validator/validator.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/bootbox/bootbox.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/cookie/jquery.cookie.min.js"></script>
	<script src="./easyui/easyloader.js"></script>

	<link rel="stylesheet" href="./css/common.css">
	<script src="./js/common.js"></script>
    <script src="./adminlte-2.3.6/plugins/nicescroll/jquery.nicescroll.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/typeahead/bootstrap3-typeahead.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/bootstrap-switch/js/bootstrap-switch.min.js"></script>
    <link rel="stylesheet" href="./adminlte-2.3.6/plugins/bootstrap-switch/css/bootstrap3/bootstrap-switch.min.css">
    <style>
        .bootstrap-switch-off .bootstrap-switch-label {
            text-align: center;
        }        
        .bootstrap-switch-off .bootstrap-switch-label:before {
            content: "\300b";
        }        
        .bootstrap-switch-on .bootstrap-switch-label:before {
            content: "\300a";
        }        
        .bootstrap-switch .bootstrap-switch-handle-off.bootstrap-switch-success,
        .bootstrap-switch .bootstrap-switch-handle-on.bootstrap-switch-success {
            color: #fff;
            background: #00a65a;
        }
    </style>
</head>
<body class="hold-transition skin-green sidebar-mini hide">
	<script>
	    try {
	        $(document).on("transitionend", ".content-wrapper", function () {
	            localStorage["sidebar-collapse"] = $("body").hasClass("sidebar-collapse") ? "sidebar-collapse" : "";
	        });
	        $("body").addClass(localStorage["sidebar-collapse"]);
	    } catch (e) {
	    }
	</script>
	<div class="wrapper">

		<header class="main-header">

			<a href="#" class="logo">
				<!-- mini logo for sidebar mini 50x50 pixels -->
				<span class="logo-mini">NVR</span>
				<!-- logo for regular state and mobile devices -->
				<span class="logo-lg">EasyNVR</span>
			</a>

			<nav class="navbar navbar-static-top" role="navigation">
				<a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
					<span class="sr-only">Toggle navigation</span>
				</a>
				<div class="navbar-custom-menu">
					<ul class="nav navbar-nav">
						<li>
	                        <a id="btn-modify-pwd" href="#" data-toggle="modal" data-target="#pwd-dlg"><i
	                                class="fa fa-key"></i> 修改密码</a>
	                    </li>
	                    <li>
	                        <a id="btn-logout" href="javascript:void(0);"><i class="fa fa-power-off"></i> 注 销</a>
	                    </li>
					</ul>
				</div>
			</nav>
		</header>
		<aside class="main-sidebar main-sidebar-gray">
			<section class="sidebar">
				<ul class="sidebar-menu">
					<li class="treeview">
						<a href="/">
							<i class="fa fa-video-camera"></i>
							<span>视频广场</span>
						</a>
					</li>
					<li class="treeview">
						<a href="/channel.html">
							<i class="fa fa-road"></i>
							<span>通道配置</span>
						</a>
					</li>
					<li class="treeview">
						<a href="/config.html">
							<i class="fa fa-cogs"></i>
							<span>本地配置</span>
						</a>
					</li>
					<!--li class="treeview">
						<a href="/recordpath.html">
							<i class="fa fa-dashboard"></i>
							<span>存储配置</span>
						</a>
					</li-->
					<li class="treeview">
						<a href="/about.html">
							<i class="fa fa-support"></i>
							<span>版本信息</span>
							<span class="pull-right-container">
								<button id="reboot-btn" class="label pull-right btn btn-sm btn-primary">
									<i class="fa fa-power-off text-orange"></i> 重启
								</button>
							</span>
						</a>
					</li>
				</ul>
			</section>
		</aside>

	    <div class="modal fade" id="pwd-dlg">
	        <div class="modal-dialog">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
	                    <h4 class="modal-title">修改密码</h4>
	                </div>
	                <form id="pwd-form" class="form-horizontal" data-toggle="validator" data-disable="false">
	                    <div class="modal-body">
	                        <div class="form-group">
	                            <label for="input-old-pwd" class="col-sm-3 control-label">
	                                原密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-old-pwd" type="password" name="oldPwd" class="form-control" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                        <div class="form-group">
	                            <label for="input-new-pwd" class="col-sm-3 control-label">
	                                新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-new-pwd" type="password" name="newPwd" class="form-control" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                        <div class="form-group">
	                            <label for="input-new-pwd2" class="col-sm-3 control-label">
	                                确认新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-new-pwd2" type="password" name="newPwd2" class="form-control"
	                                       data-match="#input-new-pwd"
	                                       data-match-error="两次密码输入不一致" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
	                        <button type="submit" class="btn btn-primary">确定</button>
	                    </div>
	                </form>
	            </div>
	        </div>
	    </div>

		<div class="content-wrapper">
			<section class="content-header">
				<ol class="breadcrumb">
					<li><a href="/"><i class="fa fa-dashboard"></i> 首页</a></li>
				</ol>
			</section>
			<section class="content">

<script>
	//var openurls = ["/","/about.html"];
	var token = $.cookie("token")||"";
	//if(!token && $.inArray(location.pathname,openurls) < 0){
	//	top.location.href = "/login.html";
	//}
	if(!token){
		$(".treeview [href=/config.html]").closest(".treeview").hide();
		$(".treeview [href=/channel.html]").closest(".treeview").hide();
	}
	$("#btn-logout").click(function(){
		$.get(_url + "/logout");
		$.cookie("token","",{expires : -1});
		$.cookie("username","",{expires : -1});
		top.location.href = "/login.html";
	})
	$("#reboot-btn").click(function(){
		var $this = $(this);
		bootbox.confirm({
			title : "提示",
			message : "确定要重启吗?",
			buttons : {
				confirm : {
					label : "确定",
					className : "btn-primary btn-sm",
				},
				cancel : {
					label : "取消",
					className : "btn-sm",
				}
			},
			callback : function(result) {
				if (result) {
					$this.prop("disabled",true);
					$.ajax({
						type : "GET",
						url : _url + "/restart",
						success : function(data){
							$.gritter.add({
								text : '重启中...',
								class_name : 'gritter-info'
							});
						},
						complete : function(xhr, ts){
							$this.prop("disabled",false);
						}
					})
				}
			}
		});										
		return false;
	})
	$('#pwd-form').validator().on('submit', function (e) {
		if (!e.isDefaultPrevented()) {
			e.preventDefault();
			var _oldPwd = $("#pwd-form [name=oldPwd]").val();
			var _newPwd = $("#pwd-form [name=newPwd]").val();
			if (!/^[a-zA-Z0-9]+$/.test(_newPwd) || _newPwd.length > 16) {
				$.gritter.add("密码长度不超过16字符，为英文或数字!");
				return false;
			}
			$("#pwd-form [type=submit]").prop("disabled",true);
			$.ajax({
				type : "GET",
				url : _url + "/modifypassword",
				data : {
					oldpassword : $.md5(_oldPwd),
					newpassword : $.md5(_newPwd)
				},
				global : false,
				success : function(data){
					try{
						console.log(data);
						var ret = JSON.parse(data);
						$.cookie("token",ret.EasyDarwin.Body.Token);
						$.gritter.add({
							text : "修改密码成功!",
							class_name : "gritter-info"
						});
						$("#pwd-dlg").modal("hide");
						return;
					}catch(e){}
					$.gritter.add("修改密码不成功!");
				},
				error : function(xhr,ts,err){
					$.gritter.add("修改密码不成功!");
				},
				complete : function(){
					$("#pwd-form [type=submit]").prop("disabled",false);
				}
			});
		}
	});	
</script>
<script>
	$(".breadcrumb").append("<li class='active'><i class='fa fa-dashboard'></i> 存储配置</li>");
</script>

    <div class="recordpath-template hide">
        <div class="col-xs-12 recordpath-info">
            <div class="col-xs-2 no-margin no-padding">
                <div class="row">&nbsp;</div>
                <h3 class="row text-right text-success no-margin"><i class="fa fa-hdd-o"></i></h3>
                <div class="row">&nbsp;</div>
            </div>
            <div class="col-xs-8">
                <div><strong>{Path}</strong></div>
                <div class="progress" style="margin-bottom:0;">
                    <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="{precent}" aria-valuemin="0" aria-valuemax="100"
                        style="width: {precent}%">
                        {precent}%
                    </div>
                </div>
                <div>{AvailableSize}可用, 共{TotalSize}
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row">&nbsp;</div>
                <div class="row">
                    <input type="checkbox" class="enable-toggle">
                </div>
                <div class="row">&nbsp;</div>
            </div>
        </div>
    </div>

    <div class="jumbotron" style="background-color:#ccc;padding: 10px 0;">
        <div class="container-fluid">
        </div>
    </div>

    <script>
    $(function(){
	    $.get(_url + "/getrecordpathlist",function(data){
            try{
                var ret = JSON.parse(data);                
                $.each(ret.EasyDarwin.Body.Paths,function(i,path){
                    var html = $(".recordpath-template").html();
                    var Path = path.Path;
                    var TotalSize = Math.round(path.TotalSize/1024/1024/1024)+"G";
                    var AvailableSize = Math.round(path.AvailableSize/1024/1024/1024)+"G";
                    var precent = Math.round((path.TotalSize-path.AvailableSize)*100/path.TotalSize);
                    html = html.replace('{Path}',Path);
                    html = html.replace('{TotalSize}',TotalSize);
                    html = html.replace('{AvailableSize}',AvailableSize);
                    html = html.replace('{precent}',precent);
                    html = html.replace('{precent}',precent);
                    html = html.replace('{precent}',precent);
                    var $recordpath = $(html);
                    $recordpath.data("path",path);
                    $(".container-fluid").append($recordpath);
                    renderPath($recordpath);
                })
            }catch(e){}
        })

        $(document).on("switchChange.bootstrapSwitch",".recordpath-info .enable-toggle",function(event,state){
            var $this = $(this);
            var $recordpath = $this.closest(".recordpath-info");
            var recordpath = $recordpath.data("path");
            var used = recordpath.Used;
            var _used = used == 'Used' ? 'Unused' : 'Used';
            var newUrl;
            var newPara;
            if(_used == 'Used') {
                newUrl = _url + "/addrecordpath";
                newPara = {'path':recordpath.Path,'reserve':2048};
            }else if(_used == 'Unused'){
                newUrl = _url + "/removerecordpath";
                newPara = {'path':recordpath.Path};
            }
            $.get(newUrl, newPara, function(data) {
                try{
                    var ret = JSON.parse(data);
                    if(ret.EasyDarwin.Header.ErrorNum != "200"){
                        throw new Error("error num != 200");
                    }
                    recordpath["Used"] = _used;
                    $.gritter.add({
                        text : '配置成功, 即时生效!',
                        class_name : 'gritter-info'
                    });
                }catch(e){
                    console.log(e);
                    recordpath["Used"] = used;
                    $.gritter.add({
                        text : '配置失败!',
                        class_name : 'gritter-error'
                    })
                }
                $recordpath.data('path',recordpath);
                renderPath($recordpath);
            });
        })
        function renderPath($recordpath){
            var recordpath = $recordpath.data("path");
            $recordpath.find('input.enable-toggle').bootstrapSwitch("destroy").bootstrapSwitch({
                size : 'mini',
                onColor : 'success',
                onText : '录像盘',
                offText : '非录像盘',
                state : recordpath["Used"] == 'Used',
                labelWidth : 10
            });          
        }
    })
</script> </section>
</div>
<!-- content-wrapper -->

<footer class="main-footer">
	<div class="pull-right hidden-xs">
		EasyNVR
	</div>
	<strong>Copyright &copy; 2016 <a href="#">www.easydarwin.org</a>.</strong> All rights reserved.
</footer>
</div>
<!-- wrapper-->
</body>

</html>