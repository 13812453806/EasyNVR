<!DOCTYPE html>
<html>

<head>
		<title>EasyNVR</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" href="./adminlte-2.3.6/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/font-awesome-4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/ionicons-2.0.1/css/ionicons.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/AdminLTE.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/skins/skin-green.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

	<script src="./adminlte-2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
	<script src="./adminlte-2.3.6/bootstrap/js/bootstrap.min.js"></script>
	<script src="./adminlte-2.3.6/dist/js/app.js"></script>
	<script src="./adminlte-2.3.6/plugins/slimScroll/jquery.slimscroll.min.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/iCheck/all.css">
	<script src="./adminlte-2.3.6/plugins/iCheck/icheck.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/md5/jquery.md5.js"></script>
	<script src="./adminlte-2.3.6/plugins/input-number/jquery.inputnumber.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/gritter/jquery.gritter.css">
	<script src="./adminlte-2.3.6/plugins/gritter/jquery.gritter.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.css">
	<script src="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/validator/validator.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/bootbox/bootbox.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/cookie/jquery.cookie.min.js"></script>
	<script src="./easyui/easyloader.js"></script>

	<link rel="stylesheet" href="./css/common.css">
	<script src="./js/common.js"></script>
</head>
<body class="hold-transition skin-green sidebar-mini hide">
	<script>
	    try {
	        $(document).on("transitionend", ".content-wrapper", function () {
	            localStorage["sidebar-collapse"] = $("body").hasClass("sidebar-collapse") ? "sidebar-collapse" : "";
	        });
	        $("body").addClass(localStorage["sidebar-collapse"]);
	    } catch (e) {
	    }
	</script>
	<div class="wrapper">

		<header class="main-header">

			<a href="#" class="logo">
				<!-- mini logo for sidebar mini 50x50 pixels -->
				<span class="logo-mini">NVR</span>
				<!-- logo for regular state and mobile devices -->
				<span class="logo-lg">EasyNVR</span>
			</a>

			<nav class="navbar navbar-static-top" role="navigation">
				<a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
					<span class="sr-only">Toggle navigation</span>
				</a>
				<div class="navbar-custom-menu">
					<ul class="nav navbar-nav">
						<li>
	                        <a id="btn-modify-pwd" href="#" data-toggle="modal" data-target="#pwd-dlg"><i
	                                class="fa fa-key"></i> 修改密码</a>
	                    </li>
	                    <li>
	                        <a id="btn-logout" href="javascript:void(0);"><i class="fa fa-power-off"></i> 注 销</a>
	                    </li>
					</ul>
				</div>
			</nav>
		</header>
		<aside class="main-sidebar main-sidebar-gray">
			<section class="sidebar">
				<ul class="sidebar-menu">
					<li class="treeview">
						<a href="/">
							<i class="fa fa-video-camera"></i>
							<span>视频广场</span>
						</a>
					</li>
					<li class="treeview">
						<a href="/channel.html">
							<i class="fa fa-road"></i>
							<span>通道配置</span>
						</a>
					</li>
					<li class="treeview">
						<a href="/config.html">
							<i class="fa fa-cogs"></i>
							<span>本地配置</span>
						</a>
					</li>
					<!--li class="treeview">
						<a href="/recordpath.html">
							<i class="fa fa-dashboard"></i>
							<span>存储配置</span>
						</a>
					</li-->
					<li class="treeview">
						<a href="/about.html">
							<i class="fa fa-support"></i>
							<span>版本信息</span>
							<span class="pull-right-container">
								<button id="reboot-btn" class="label pull-right btn btn-sm btn-primary">
									<i class="fa fa-power-off text-orange"></i> 重启
								</button>
							</span>
						</a>
					</li>
				</ul>
			</section>
		</aside>

	    <div class="modal fade" id="pwd-dlg">
	        <div class="modal-dialog">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
	                    <h4 class="modal-title">修改密码</h4>
	                </div>
	                <form id="pwd-form" class="form-horizontal" data-toggle="validator" data-disable="false">
	                    <div class="modal-body">
	                        <div class="form-group">
	                            <label for="input-old-pwd" class="col-sm-3 control-label">
	                                原密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-old-pwd" type="password" name="oldPwd" class="form-control" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                        <div class="form-group">
	                            <label for="input-new-pwd" class="col-sm-3 control-label">
	                                新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-new-pwd" type="password" name="newPwd" class="form-control" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                        <div class="form-group">
	                            <label for="input-new-pwd2" class="col-sm-3 control-label">
	                                确认新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
	                            <div class="col-sm-8">
	                                <input id="input-new-pwd2" type="password" name="newPwd2" class="form-control"
	                                       data-match="#input-new-pwd"
	                                       data-match-error="两次密码输入不一致" required>
	                                <span class="help-block with-errors"></span>
	                            </div>
	                        </div>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
	                        <button type="submit" class="btn btn-primary">确定</button>
	                    </div>
	                </form>
	            </div>
	        </div>
	    </div>

		<div class="content-wrapper">
			<section class="content-header">
				<ol class="breadcrumb">
					<li><a href="/"><i class="fa fa-dashboard"></i> 首页</a></li>
				</ol>
			</section>
			<section class="content">

<script>
	//var openurls = ["/","/about.html"];
	var token = $.cookie("token")||"";
	//if(!token && $.inArray(location.pathname,openurls) < 0){
	//	top.location.href = "/login.html";
	//}
	if(!token){
		$(".treeview [href=/config.html]").closest(".treeview").hide();
		$(".treeview [href=/channel.html]").closest(".treeview").hide();
	}
	$("#btn-logout").click(function(){
		$.get(_url + "/logout");
		$.cookie("token","",{expires : -1});
		$.cookie("username","",{expires : -1});
		top.location.href = "/login.html";
	})
	$("#reboot-btn").click(function(){
		var $this = $(this);
		bootbox.confirm({
			title : "提示",
			message : "确定要重启吗?",
			buttons : {
				confirm : {
					label : "确定",
					className : "btn-primary btn-sm",
				},
				cancel : {
					label : "取消",
					className : "btn-sm",
				}
			},
			callback : function(result) {
				if (result) {
					$this.prop("disabled",true);
					$.ajax({
						type : "GET",
						url : _url + "/restart",
						success : function(data){
							$.gritter.add({
								text : '重启中...',
								class_name : 'gritter-info'
							});
						},
						complete : function(xhr, ts){
							$this.prop("disabled",false);
						}
					})
				}
			}
		});										
		return false;
	})
	$('#pwd-form').validator().on('submit', function (e) {
		if (!e.isDefaultPrevented()) {
			e.preventDefault();
			var _oldPwd = $("#pwd-form [name=oldPwd]").val();
			var _newPwd = $("#pwd-form [name=newPwd]").val();
			if (!/^[a-zA-Z0-9]+$/.test(_newPwd) || _newPwd.length > 16) {
				$.gritter.add("密码长度不超过16字符，为英文或数字!");
				return false;
			}
			$("#pwd-form [type=submit]").prop("disabled",true);
			$.ajax({
				type : "GET",
				url : _url + "/modifypassword",
				data : {
					oldpassword : $.md5(_oldPwd),
					newpassword : $.md5(_newPwd)
				},
				global : false,
				success : function(data){
					try{
						console.log(data);
						var ret = JSON.parse(data);
						$.cookie("token",ret.EasyDarwin.Body.Token);
						$.gritter.add({
							text : "修改密码成功!",
							class_name : "gritter-info"
						});
						$("#pwd-dlg").modal("hide");
						return;
					}catch(e){}
					$.gritter.add("修改密码不成功!");
				},
				error : function(xhr,ts,err){
					$.gritter.add("修改密码不成功!");
				},
				complete : function(){
					$("#pwd-form [type=submit]").prop("disabled",false);
				}
			});
		}
	});	
</script>
<script>
	$(".breadcrumb").append("<li class='active'><i class='fa fa-cogs'></i> 本地配置</li>");
</script>
<div class="container-fluid no-padding">
	<div class="nav-tabs-custom col-lg-offset-2 col-lg-8 no-padding">
		<ul class="nav nav-tabs">
			<li class="active"><a href="#web-config" data-toggle="tab">WEB 相关配置</a></li>
			<li class=""><a href="#nvr-config" data-toggle="tab">EasyNVR 基础配置</a></li>
			<li class=""><a href="#platform-config" data-toggle="tab">第三方平台接入</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="web-config">
				<form role="form" class="form-horizontal" data-toggle="validator" data-disable="false">
					<div class="form-group">
						<label for="nginx-local-path" class="col-sm-4 control-label">NGINX 本地磁盘根目录</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="nginx-local-path" name="NginxRootFolder" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group hide">
						<label for="nginx-web-path" class="col-sm-4 control-label">NGINX WEB 地址</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="nginx-web-path" name="NginxWebPath" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="nginx-rtmp-path" class="col-sm-4 control-label">NGINX RTMP 地址</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="nginx-rtmp-path" name="NginxRTMPPath" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-4 col-sm-7">
							<button type="submit" class="btn btn-primary">保存</button>
						</div>
					</div>
				</form>
			</div>
			<div class="tab-pane" id="nvr-config">
				<form role="form" class="form-horizontal" data-toggle="validator" data-disable="false">
					<div class="form-group">
						<label for="service-lan-port" class="col-sm-4 control-label">EasyNVR 本地端口</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="service-lan-port" name="ServiceLanPort" pattern="^[0-9]+$" readonly="readonly"
								required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="service-lan-ip" class="col-sm-4 control-label">EasyNVR 本地地址</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="service-lan-ip" name="ServiceLanIP" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="service-wan-port" class="col-sm-4 control-label">EasyNVR 公网端口</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="service-wan-port" name="ServiceWanPort" pattern="^[0-9]+$" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="service-wan-ip" class="col-sm-4 control-label">EasyNVR 公网地址</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="service-wan-ip" name="ServiceWanIP" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="channel-snap-interval" class="col-sm-4 control-label">快照间隔时间(S)</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="channel-snap-interval" name="ChannelSnapInterval" pattern="^[0-9]+$" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-4 col-sm-7">
							<button type="submit" class="btn btn-primary">保存</button>
						</div>
					</div>
				</form>
			</div>
			<div class="tab-pane" id="platform-config">
				<form role="form" class="form-horizontal" data-toggle="validator" data-disable="false">
					<div class="form-group">
						<label for="platform-name" class="col-sm-4 control-label">接入平台</label>
						<div class="col-sm-7">
							<select name="ThridPlatform" id="platform-name" class="form-control">
							<option value="" selected="selected">不启用</option>
							<option value="EasyDarwin">EasyDarwin</option>
						</select>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-ip" class="col-sm-4 control-label">IP 地址</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-ip" name="ThridPlatformIP" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-port" class="col-sm-4 control-label">监听端口</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-port" name="ThridPlatformPort" pattern="^[0-9]+$" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-token" class="col-sm-4 control-label">Token</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-token" name="ThridPlatformToken" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-uid" class="col-sm-4 control-label">UID</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-uid" name="ThridPlatformUID" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-interval" class="col-sm-4 control-label">保活时间</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-interval" name="ThridPlatformAliveInterval" pattern="^[0-9]+$" required>
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<label for="platform-customize" class="col-sm-4 control-label">自定义配置</label>
						<div class="col-sm-7">
							<input type="text" class="form-control" id="platform-customize" name="ThridPlatformCustomize">
							<span class="help-block with-errors"></span>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-4 col-sm-7">
							<button type="submit" class="btn btn-primary">保存</button>
						</div>
					</div>
				</form>
			</div>
		</div>
		<!-- /.tab-content -->
	</div>
</div>
<script>
	function reload(){
		$.get(_url + "/getbaseconfig",function(data){
			try{
				var ret = JSON.parse(data);
				$("#web-config form").form("load",ret.EasyDarwin.Body);
				$("#nvr-config form").form("load",ret.EasyDarwin.Body);
			}catch(e){}
		});
		$.get(_url + "/getthirdplatformconfig",function(data){
			try{
				var ret = JSON.parse(data);
				$("#platform-config form").form("load",ret.EasyDarwin.Body);
				$("[name=ThridPlatform]").trigger("change");
			}catch(e){}
		});
	}
	$(function(){
		easyloader.load(['form'],function(){
			reload();
		});
        $('#web-config form, #nvr-config form').validator().on('submit', function(e) {
            if (!e.isDefaultPrevented()) {
                e.preventDefault();
				var interval = parseInt($("[name=ChannelSnapInterval]").val());
				if(isNaN(interval) || interval < 30){
					$.gritter.add("间隔时间要求 >= 30");
					return;
				}
				var $this = $(this);
				$this.find("button[type=submit]").prop("disabled",true);
				$.ajax({
					type : "GET",
					url : _url + "/setbaseconfig",
					data : $this.serialize(),
					success : function(data){
						reload();
						$.gritter.add({
							text : '配置成功,重启后生效!',
							class_name : 'gritter-info'
						});
					},
					complete : function(xhr, ts){
						$this.find("button[type=submit]").prop("disabled",false);
					}
				})
            }
        });
        $('#platform-config form').validator().on('submit', function(e) {
            if (!e.isDefaultPrevented()) {
                e.preventDefault();
				var $this = $(this);
				$this.find("button[type=submit]").prop("disabled",true);
				$.ajax({
					type : "GET",
					url : _url + "/setthirdplatformconfig",
					data : $this.serialize(),
					success : function(data){
						reload();
						$.gritter.add({
							text : '配置成功,即时生效!',
							class_name : 'gritter-info'
						});
					},
					complete : function(xhr, ts){
						$this.find("button[type=submit]").prop("disabled",false);
					}
				})
            }
        });		
		$("[name=ThridPlatform]").change(function(){
			var val = $(this).val();
			if(!val){
				//$('#platform-config form').find(".form-group").removeClass("has-error").removeClass("has-success");
       	 		//$('#platform-config form').find(".with-errors").empty();
				//$('#platform-config form')[0].reset();
				$('#platform-config form :input').not(this).not(":submit").prop("disabled",true);
			}else{
				$('#platform-config form :input').not(this).not(":submit").prop("disabled",false);
			}
		});
	})
</script>
</section>
</div>
<!-- content-wrapper -->

<footer class="main-footer">
	<div class="pull-right hidden-xs">
		EasyNVR
	</div>
	<strong>Copyright &copy; 2016 <a href="#">www.easydarwin.org</a>.</strong> All rights reserved.
</footer>
</div>
<!-- wrapper-->
</body>

</html>