<!DOCTYPE html>
<html>

<head>
		<title>EasyNVR</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" href="./adminlte-2.3.6/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/font-awesome-4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/ionicons-2.0.1/css/ionicons.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/AdminLTE.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/skins/skin-green.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

	<script src="./adminlte-2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
	<script src="./adminlte-2.3.6/bootstrap/js/bootstrap.min.js"></script>
	<script src="./adminlte-2.3.6/dist/js/app.js"></script>
	<script src="./adminlte-2.3.6/plugins/slimScroll/jquery.slimscroll.min.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/iCheck/all.css">
	<script src="./adminlte-2.3.6/plugins/iCheck/icheck.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/md5/jquery.md5.js"></script>
	<script src="./adminlte-2.3.6/plugins/input-number/jquery.inputnumber.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/gritter/jquery.gritter.css">
	<script src="./adminlte-2.3.6/plugins/gritter/jquery.gritter.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.css">
	<script src="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/validator/validator.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/bootbox/bootbox.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/cookie/jquery.cookie.min.js"></script>
	<script src="./easyui/easyloader.js"></script>

	<link rel="stylesheet" href="./css/common.css">
	<script src="./js/common.js"></script>
	<script src="./js/cyberplayer.js"></script>
	<script src="./adminlte-2.3.6/plugins/moment/moment-with-locales.js"></script>
	<link rel="stylesheet" type="text/css" media="all" href="./adminlte-2.3.6/plugins/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="./adminlte-2.3.6/plugins/daterangepicker/moment.js"></script>
    <script type="text/javascript" src="./adminlte-2.3.6/plugins/daterangepicker/daterangepicker.js"></script>
	<style>
		.channel-title {
			position: absolute;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
			color: #fff;
			text-align: center;
			padding: 0 15px;
			font-size: 20px;
			line-height: 50px;
			font-weight: 700;
		}
		
		#dvplay {
			margin: 0 auto;
			width: 80%;
			height: 500px;
		}
		
		#ruler {
			border: 0;
			border-top: 1px solid #333;
			padding: 0;
			margin: 0;
			background-color: transparent;
			height: 80px;
			position: relative;
		}
		
		#ruler .two-hour {
			border: 0;
			border-left: 1px solid #333;
			padding: 0;
			margin: 0;
			height: 30px;
		}
		
		#ruler .two-hour:first-child {
			border-left: 0;
		}
		
		#ruler .two-hour:last-child {
			border-right: 1px solid #333;
		}
		
		#ruler .ten-minute {
			border: 0;
			border-left: 1px solid #333;
			padding: 0;
			margin: 0;
			height: 20px;
		}
		
		#ruler .two-hour .ten-minute:first-child {
			border-left: 0;
		}
		
		#timer {
			position: absolute;
			width: 1px;
			border: 0;
			left: 0;
			height: 40px;
			overflow: visiable;
			background-color: red;
		}
		
		#timer #handle {
			position: absolute;
			width: 100px;
			height: 30px;
			line-height: 30px;
			top: 40px;
			left: -50px;
			background-color: #00a65a;
			text-align: center;
			color: #fff;
		}
	</style>
</head>

<body class="hold-transition skin-green layout-top-nav">
	<script>
	    try {
	        $(document).on("transitionend", ".content-wrapper", function () {
	            localStorage["sidebar-collapse"] = $("body").hasClass("sidebar-collapse") ? "sidebar-collapse" : "";
	        });
	        $("body").addClass(localStorage["sidebar-collapse"]);
	    } catch (e) {
	    }
	</script>

	<div class="wrapper">

		<header class="main-header">
			<nav class="navbar navbar-static-top" role="navigation">
				<div class="channel-title"></div>
				<div class="navbar-custom-menu pull-left">
					<ul class="nav navbar-nav">
						<li>
							<a id="btn-modify-pwd" href="javascript:top.history.go(-1);" data-toggle="modal"><i
	                                class="fa fa-chevron-left"></i> 返回</a>
						</li>
					</ul>
				</div>
			</nav>
		</header>
		<div class="content-wrapper">
			<section class="content easyui-wrapper">
				<div id="dvplay"></div>
				<br>
				<div class="row hidden-xs hidden-sm hidden-md hidden-lg">
					<div class="col-xs-2">
						<input type="text" class="form-control input-sm" id="searchdate" width="30" readonly>
					</div>
					<div class="col-xs-2">
						<button type="btn" class="btn btn-success btn-sm" onclick="secrchRecords()">查询录像</button>
						<button type="btn" class="btn btn-success btn-sm" onclick="viewLive()">观看直播</button>
					</div>
				</div>
				<div class="tab-pane active hidden-xs hidden-sm hidden-md hidden-lg" id="ruler" style="margin-top:20px;">
					<div id="timer" class="easyui-draggable" handle="#handle" axis="h" data-options="onDrag:onDrag,onStopDrag:onStopDrag">
						<div id="handle">title</div>
					</div>
				</div>
			</section>
		</div>
		<footer class="main-footer">
			<div class="pull-right hidden-xs">
				EasyNVR
			</div>
			<strong>Copyright &copy; 2016 <a href="#">www.easydarwin.org</a>.</strong> All rights reserved.
		</footer>
	</div>
	<!-- wrapper-->
	<script>
		function myformatter(date){
			var y = date.getFullYear();
			var m = date.getMonth()+1;
			var d = date.getDate();
			return y+"-"+(m<10?('0'+m):m)+"-"+(d<10?('0'+d):d);
		}
		function myformatter2(date){
			var y = date.getFullYear();
			var m = date.getMonth()+1;
			var d = date.getDate();
			return y+""+(m<10?('0'+m):m)+(d<10?('0'+d):d);
		}
		function myparser(s){
			if (!s) return new Date();
			var ss = (s.split('-'));
			var y = parseInt(ss[0],10);
			var m = parseInt(ss[1],10);
			var d = parseInt(ss[2],10);
			if (!isNaN(y) && !isNaN(m) && !isNaN(d)){
				return new Date(y,m-1,d);
			}else{
				return new Date();
			}
		}
		var search_date = new Date();
		var load_records = [];//记录加载的所有录像段
		var recordIndex;//记录当前播放的是那个录像段
		var timerLive;//观看直播保持心跳
		var timerRecord;//观看录像保持心跳
		var timerRecordSession = '';//录像心跳session
		var player = setupPlayer($.cookie("videoUrl"), $.cookie("videoImg"));
		function setupPlayer(videoUrl, videoImg){
			var player = cyberplayer("dvplay").setup({
				flashplayer: "cyberplayer.flash.swf",
				stretching: "uniform",
				file : videoUrl||"rtmp://121.40.50.44/live/stream_1",
				image : videoImg||"/images/snap.png",
				width : $("#dvplay").width(),
				height: $("#dvplay").width() * 3/5,
				autostart: false,
				repeat: false,
				volume: 100,
				controls: true,
				controlbar: {
					barLogo: false
				},
				ak: '515d61b893134f40bd4297b75a03494b' // 公有云平台注册即可获得accessKey
			});
			return player;
		}
		player.on("ready",function(){
			player.play();
		})
		function secrchRecords(){
			var s_date = $('#searchdate').val();
			if(s_date != '' && s_date != myformatter(search_date)){
				loadRecords(new Date(s_date));
			}
		}
		function viewLive(){
			stopRecord();
			posTimer(new Date());
			player = setupPlayer($.cookie("videoUrl"), $.cookie("videoImg"));
		}
		moment.locale("zh-cn");
		function onDrag(e){
			var d = e.data;
			var range = $(d.parent).innerWidth() - 1;
			if (d.left < 0) {
				d.left = 0;
			}
			if (d.left > range) {
				d.left = range;
			}
			var left = parseInt(d.left);
			var pos = left * 10000/range;
			var m = moment().startOf("day");
			var secs = 3600 * 24 * pos /10000;
			m.add(secs,"seconds");
			var title = m.format("HH:mm:ss");
			$("#handle").text(title).attr("title",title);
			$("#timer").data("pos",pos);
		}
		function onStopDrag(e){
			var d = e.data;
			var left = parseInt(d.left);
			var havaRecordFlag = 0;//记录当前拖动的位置是否有录像
			$.each(load_records, function(i, load_record){
				if(left >= load_record[0] && left <= load_record[1]){
					havaRecordFlag = 1;
					clearInterval(timerLive);
					var range = $(d.parent).innerWidth() - 1;
					var pos = left * 10000/range;
					var m = moment().startOf("day");
					var secs = 3600 * 24 * pos /10000;
					m.add(secs,"seconds");
					var date_time = myformatter2(search_date) + m.format("HHmmss");
					if(recordIndex == i){
						$.get(_url+"/seekplayrecord",
							{channel: $.cookie("channel"), sessionid: timerRecordSession, datetime: date_time},
							function(data){})
					}else{
						stopRecord();
						recordIndex = i;
						$.get(_url+"/playrecord",{channel:$.cookie("channel"), datetime: date_time},function(data){
							var ret = JSON.parse(data);
							var record_url = ret.EasyDarwin.Body.URL;
							timerRecordSession = ret.EasyDarwin.Body.SessionID;
							player = setupPlayer(record_url, '');					
							timerRecord = setInterval(function(){
								$.get(_url + "/touchplayrecord",{
									Channel : $.cookie("channel"),
									sessionid : timerRecordSession
								},function(data){
									console.log(data);
								})
							}, 30000);
						})
					}
				}
			})
			if(havaRecordFlag == 0){
				stopRecord();
			}
		}
		function stopRecord(){
			recordIndex = -1;
			clearInterval(timerRecord);
			player.stop();
			if(timerRecordSession != ''){
				$.get(_url+"/stopplayrecord",
					{channel: $.cookie("channel"), sessionid: timerRecordSession}, function(data){})
				timerRecordSession = '';
			}
		}
		function posTimer(date){
			var m = moment(date);
			var secs = m.hours() * 3600 + m.minutes() * 60 + m.seconds();
			var pos = (secs * 10000) / (3600 * 24);
			var title = m.format("HH:mm:ss");
			$("#handle").text(title).attr("title",title);
			$("#timer").data("pos",pos).css("left",($("#ruler").innerWidth()-1) * pos /10000);
		}
		function loadRecords(date){
			load_records = [];
			$(".temp_record").remove();
			$.get(_url + "/searchrecord", {channel: $.cookie("channel"), date: myformatter2(date)}, function(data){
				try{
					var ret = JSON.parse(data);				
					$.each(ret.EasyDarwin.Body.Records,function(i,record){
						var mLeft = record.StartTime.split(":");
						var mRight = record.EndTime.split(":");
						var secLeft = parseInt(mLeft[0]) * 3600 + parseInt(mLeft[1]) * 60 + parseInt(mLeft[2]);
						var secRight = parseInt(mRight[0]) * 3600 + parseInt(mRight[1]) * 60 + parseInt(mRight[2]);
						var posLeft = (secLeft * 10000) / (3600 * 24);
						var posRight = (secRight * 10000) / (3600 * 24);
						var left = ($("#ruler").innerWidth()-1) * posLeft /10000;
						var right = ($("#ruler").innerWidth()-1) * posRight /10000;
						var width = right - left;
						var v_record = "<div class=\"temp_record\" style=\"left: "+left+"px; width:"+width+"px; height:20px; position: absolute; background-color:#00a65a;\"></div>";
						$("#ruler").append(v_record);
						var load_record = [left, right];
						load_records[i] = load_record;
					})
					search_date = date;
				}catch(e){}
			})
		}

		$(function () {
			var date = new Date();	
			$('#searchdate').daterangepicker({
				singleDatePicker: true,
				startDate: moment().subtract(0, 'days'),
				locale:{
					format: 'YYYY-MM-DD',
					separator: ' - ',
					daysOfWeek: [ '日', '一', '二', '三', '四', '五', '六' ],
					monthNames: [ '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月' ],
					firstDay: moment.localeData().firstDayOfWeek()
				}
			});
			$('#searchdate').val(myformatter(date));
			player.resize($(window).width() * 0.8, $(window).width() * 0.8 * 3 /5);
			for(var i=0;i<12;i++){
				var $minute = $("<div class='col-xs-1 row two-hour'></div>");
				$("#ruler").append($minute);
				for(var j=0;j<12;j++){
					var $second = $("<div class='col-xs-1 ten-minute'></div>");
					$minute.append($second);
				}
			}
			function onWindowResize(){
				var w = $(window).width();
				player.resize(w*0.8, w*0.8*3/5);
				var pos = $("#timer").data("pos")||0;
				$("#timer").css("left",($("#ruler").innerWidth()-1) * pos /10000);
			}
			var resizeEvt = "orientationchange" in window ? "orientationchange" : "resize";
			window.addEventListener(resizeEvt,onWindowResize,false);		
			//posTimer(date);
			//loadRecords(date);
			
			timerLive = setInterval(function(){
				$.get(_url + "/touchchannelstream",{
					Channel : $.cookie("channel"),
					Protocol : isPC() ? "RTMP" : "HLS",
					Line : "local",
					From : "lan"
				},function(data){
					console.log(data);
				})
			}, 30000);

			$(".channel-title").text($.cookie("channelName")||"通道直播");
		});
	</script>
</body>
</html>